---
title: 作用域与闭包
date: 2019-07-05 22:08:06
tags:
---
### 作用域
作用域是根据名称查找变量的一套规则，并确定当前执行代码对变量访问的权限。
#### 嵌套作用域
当一个块或者函数嵌套在另一个块或者函数中是，就发生了作用域的嵌套，因此在当前作用域无法找到某变量时，引擎就会在外层作用域中继续查找，直到找到改变量，或者到达最外层的作用域（全局作用域）为止。
作用域链规则：引擎从当前的执行作用域开始查找，如果找不到就向上级继续查找，直到找到改变量，或者到达最外层的作用域（全局作用域）为止。
#### 词法作用域
当一个块或者函数嵌套在另一个块或者函数中是，就发生了作用域的嵌套，因此在当前作用域无法找到某变量时，引擎就会在外层作用域中继续查找，直到找到改变量，或者到达最外层的作用域（全局作用域）为止。
作用域链规则：引擎从当前的执行作用域开始查找，如果找不到就向上级继续查找，直到找到改变量，或者到达最外层的作用域（全局作用域）为止。
#### 词法作用域
词法作用域是指作用域由书写代码时函数声明的位置来决定的，即编译词法阶段就能基本知道全部标识符位置，声明方式，从而能预测在执行过程的查找方式。
修改词法作用域：eval()、with
```javascript
//eval 非严格模式下
function test (str, b) {
  eval(str)
  console.log(a,b)
}
var a = 1
test('var a = 33', 1)  // 33 1
//严格模式下 eval有自己的作用域
function test (str, b) {
  'use strict'
  eval(str)
  console.log(a,b)
}
var a = 1
test('var a = 33', 1) // 1 1
```
#### 函数作用域
函数作用域是指属于这个函数的所有变量都可以在整个函数的范围内使用及复用。他们把这些变量和函数及内部实现隐藏起来，外部作用域无法访问函数中的变量也无法得知他的内部实现，遵从了最小暴露原则。
优点：规避冲突，避免同名变量符之间的重复。
#### 块级作用域
ES6 引入了块级作用域，块级作用域中外层代码块不受内层代码块的影响。
块级作用域的特点：
1.允许块级作用域的任意嵌套。
2.内层作用域可以定义外层作用域的同名变量。
3.允许在块级作用域之中声明函数：
1）函数声明类似于var，即会提升到全局作用域或函数作用域的头部。
2）同时，函数声明还会提升到所在的块级作用域的头部。
创建块级作用域关键字有：try/catch，let，const
### 闭包
闭包是基于词法作用域书写代码事所产生的的自然结果，当函数可以记住并访问所在的词法作用域，即使函数是在当前词法作用域之外执行，这时就产生了闭包，或者说函数所持有的对原始定义作用域的引用就是闭包。
常见问题如下：
```javascript
for (var i = 0; i < 5; i++) {
  setTimeout(function(){
    console.log(i)
  },1000)
}

//修改之后
//一
for (var i = 0; i < 5; i++) {
  let j = i   //let 变量产生一个块级作用域
  setTimeout(function(){
    console.log(j)  //函数是一个闭包，保存对j的访问 1 2 3 4
  },1000)
}
for (let i = 0; i < 5; i++) {
  setTimeout(function(){
    console.log(i) // 1 2 3 4
  },1000)
}
//立即执行函数
for (let i = 0; i < 5; i++) {
  (function(j){
    setTimeout(function(){
      console.log(j) // 1 2 3 4
    },1000)
  })(i)
}
```